# AutoStart Persistence Locations (Windows)

This section provides a **DFIR-focused** overview of common Windows **AutoStart persistence** locations.

AutoStart locations (also called autoruns) allow software — including malware — to **execute automatically** during:

* user logon
* system startup
* Winlogon initialization

These artifacts are critical for:

* confirming persistence mechanisms
* hunting for suspicious binaries/scripts
* understanding how an attacker maintains access

---

## Table of Contents

1. [HKCU Run](#hkcu-run)
2. [HKCU RunOnce](#hkcu-runonce)
3. [HKLM RunOnce](#hklm-runonce)
4. [HKLM Policies Explorer Run](#hklm-policies-explorer-run)
5. [HKLM Run](#hklm-run)
6. [Winlogon Userinit](#winlogon-userinit)
7. [Startup Folder (Per-User)](#startup-folder-per-user)
8. [Correlation & Analyst Tips](#correlation--analyst-tips)
9. [Evasion Techniques](#evasion-techniques)
10. [Tooling Summary](#tooling-summary)

---

## HKCU Run

### AutoStart Location

```
NTUSER.DAT\Software\Microsoft\Windows\CurrentVersion\Run
```

### What is this autostart location?

The **HKCU Run** key starts listed programs **automatically when the user logs on**. The key is stored in the user’s `NTUSER.DAT` hive and applies only to that specific user.

Attackers frequently use this location because:

* it does **not require admin rights**
* it triggers reliably at logon
* it blends in with legitimate software

### Where to find this autostart location

Offline forensics:

* Hive: `C:\Users\<User>\NTUSER.DAT`
* Key Path: `Software\Microsoft\Windows\CurrentVersion\Run`

Live system:

* `HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run`

### Forensic Value

This key helps answer:

* What programs execute at logon for this user?
* Did malware set persistence without admin rights?
* Are there suspicious commands, scripts, or LOLbins used for persistence?

### Key Data Points

* Value Name (often masquerades as legitimate software)
* Command line / executable path
* Arguments (e.g., encoded PowerShell)
* Binary location (user-writable vs system path)

### Example Output (Registry Explorer)

```
Key: ...\CurrentVersion\Run

Value Name: OneDrive
Data: "C:\Program Files\Microsoft OneDrive\OneDrive.exe" /background

Value Name: Windows Update Service
Data: powershell.exe -WindowStyle Hidden -enc SQBFAFgA...
```

### Tools for parsing this autostart location

**Registry Explorer (GUI):**

* Load `NTUSER.DAT`
* Navigate to the Run key

**RECmd (CLI):**

```
RECmd.exe -f NTUSER.DAT --kn "Software\Microsoft\Windows\CurrentVersion\Run" --csv autoruns.csv
```

---

## HKCU RunOnce

### AutoStart Location

```
NTUSER.DAT\Software\Microsoft\Windows\CurrentVersion\RunOnce
```

### What is this autostart location?

**RunOnce** entries execute automatically at the next user logon, then are **removed after execution**.

This location is often abused for:

* one-time payload execution
* staging secondary persistence elsewhere
* running cleanup tools

### Where to find this autostart location

Offline:

* `NTUSER.DAT` → `Software\Microsoft\Windows\CurrentVersion\RunOnce`

Live:

* `HKCU\Software\Microsoft\Windows\CurrentVersion\RunOnce`

### Forensic Value

* Indicates one-time execution intent
* Useful for identifying transient attacker activity

### Key Data Points

* Value name
* Command line
* Whether the entry was removed (requires hive analysis / timeline)

### Example Output (Registry Explorer)

```
Value Name: AdobeUpdate
Data: "C:\Users\Public\adobe_update.exe" /silent
```

### Tools for parsing this autostart location

```
RECmd.exe -f NTUSER.DAT --kn "Software\Microsoft\Windows\CurrentVersion\RunOnce" --csv autoruns.csv
```

---

## HKLM RunOnce

### AutoStart Location

```
SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce
```

### What is this autostart location?

The **HKLM RunOnce** key triggers one-time execution at startup or logon, depending on the entry.

Unlike HKCU RunOnce, it applies to:

* all users
* system-wide execution

This typically requires admin rights to set.

### Where to find this autostart location

Offline:

* Hive: `C:\Windows\System32\config\SOFTWARE`
* Key path: `Microsoft\Windows\CurrentVersion\RunOnce`

Live:

* `HKLM\Software\Microsoft\Windows\CurrentVersion\RunOnce`

### Forensic Value

* System-wide one-time persistence
* Useful for tracking admin-level attacker persistence

### Key Data Points

* Value name
* Command line
* Whether entry is deleted post-run

### Example Output (Registry Explorer)

```
Value Name: DriverUpdate
Data: "C:\Windows\Temp\drvupdate.exe"
```

### Tools for parsing this autostart location

```
RECmd.exe -f SOFTWARE --kn "Microsoft\Windows\CurrentVersion\RunOnce" --csv autoruns.csv
```

---

## HKLM Policies Explorer Run

### AutoStart Location

```
SOFTWARE\Microsoft\Windows\CurrentVersion\policies\Explorer\Run
```

### What is this autostart location?

This key is commonly used for:

* enterprise administration
* group policy-driven logon actions

Because it appears “official,” it is sometimes abused for stealth persistence.

### Where to find this autostart location

Offline:

* Hive: `SOFTWARE`
* Path: `Microsoft\Windows\CurrentVersion\policies\Explorer\Run`

Live:

* `HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer\Run`

### Forensic Value

* May indicate policy-based persistence
* Suspicious if environment is not domain-managed

### Key Data Points

* Value names
* Commands
* Script invocation

### Example Output (Registry Explorer)

```
Value Name: LogonScript
Data: cmd.exe /c "C:\ProgramData\svc.bat"
```

### Tools for parsing this autostart location

```
RECmd.exe -f SOFTWARE --kn "Microsoft\Windows\CurrentVersion\policies\Explorer\Run" --csv autoruns.csv
```

---

## HKLM Run

### AutoStart Location

```
SOFTWARE\Microsoft\Windows\CurrentVersion\Run
```

### What is this autostart location?

The HKLM Run key launches programs at logon for **all users**.

Commonly used by:

* legitimate software (AV, sync tools)
* attackers with admin rights to establish persistence

### Where to find this autostart location

Offline:

* Hive: SOFTWARE
* Path: `Microsoft\Windows\CurrentVersion\Run`

Live:

* `HKLM\Software\Microsoft\Windows\CurrentVersion\Run`

### Forensic Value

* High-confidence persistence location
* Helps identify system-wide attacker footholds

### Key Data Points

* Executable/script path
* Arguments
* Unusual directories (Temp, AppData, Public)

### Example Output (Registry Explorer)

```
Value Name: SecurityHealth
Data: "C:\Windows\System32\SecurityHealthSystray.exe"

Value Name: Windows Audio Driver
Data: "C:\Users\Public\audiodrv.exe" --silent
```

### Tools for parsing this autostart location

```
RECmd.exe -f SOFTWARE --kn "Microsoft\Windows\CurrentVersion\Run" --csv autoruns.csv
```

---

## Winlogon Userinit

### AutoStart Location

```
SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\Userinit
```

### What is this autostart location?

The `Userinit` value controls which program runs immediately after a successful logon.

Default value:

```
C:\Windows\System32\userinit.exe,
```

Attackers may append an additional executable/script.

### Where to find this autostart location

Offline:

* Hive: SOFTWARE
* Key: `Microsoft\Windows NT\CurrentVersion\Winlogon`
* Value: `Userinit`

Live:

* `HKLM\Software\Microsoft\Windows NT\CurrentVersion\Winlogon`

### Forensic Value

* Extremely high-value persistence location
* Often indicates sophisticated attacker persistence

### Key Data Points

* Presence of extra entries appended after `userinit.exe`
* Non-standard paths

### Example Output (Registry Explorer)

```
Value Name: Userinit
Data: C:\Windows\System32\userinit.exe,C:\Users\Public\svchost.exe
```

### Tools for parsing this autostart location

```
RECmd.exe -f SOFTWARE --kn "Microsoft\Windows NT\CurrentVersion\Winlogon" --csv autoruns.csv
```

---

## Startup Folder (Per-User)

### AutoStart Location

```
%AppData%\Roaming\Microsoft\Windows\Start Menu\Programs\Startup
```

### What is this autostart location?

Files placed in the Startup folder automatically execute when the user logs in.

This is a popular attacker choice because:

* does not require admin rights
* supports `.lnk`, `.bat`, `.vbs`, `.ps1`, EXEs
* blends in with legitimate shortcuts

### Where to find this autostart location

Typical path:

```
C:\Users\<User>\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup
```

### Forensic Value

* Strong evidence of user-level persistence
* Useful for detecting dropped scripts and shortcut-based persistence

### Key Data Points

* File name
* Target path (for `.lnk`)
* Creation/modification timestamps

### Example Output (Directory Listing)

```
2024-11-18  13:40    2,048   OneDrive.lnk
2024-11-18  13:41    1,200   updater.vbs
```

### Tools for parsing this autostart location

* KAPE collection (Startup folders)
* LECmd.exe for parsing `.lnk` files

Example LECmd:

```
LECmd.exe -d "C:\Users\<User>\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup" --csv startup_links.csv
```

---

## Correlation & Analyst Tips

### Common Suspicion Indicators

* Executables launched from:

  * `C:\Users\Public`
  * `%AppData%`
  * `%Temp%`
  * `C:\ProgramData`
* Suspicious command lines:

  * `powershell.exe -enc`
  * `cmd.exe /c`
  * `mshta.exe`
  * `rundll32.exe`
* Value names designed to blend in (e.g., `Windows Update Service`)

### Recommended Correlation Artifacts

* Prefetch
* Amcache
* ShimCache
* BAM/DAM
* SRUM
* Windows Event Logs (4688, 4697, 7045)

---

## Evasion Techniques

Attackers may evade AutoStart discovery by:

* using benign-sounding value names
* deleting keys after execution (RunOnce)
* storing payloads in obscure directories
* using fileless persistence (WMI, scheduled tasks)
* replacing hives / timestomping

---

## KAPE Targets & Modules (AutoStart Collection)

KAPE collects **files** relevant to persistence. For these AutoStart locations, the primary items to collect are:

* `NTUSER.DAT` (per user)
* Startup folder contents (per user)
* Optional: `UsrClass.dat` (useful for shell artifacts / Jump Lists correlation)

### Collection Targets

| Evidence Needed            | What to Collect | Typical Paths                                                                   |
| -------------------------- | --------------- | ------------------------------------------------------------------------------- |
| HKCU Run / RunOnce keys    | `NTUSER.DAT`    | `C:\Users\<User>\NTUSER.DAT`                                                    |
| Startup Folder persistence | Startup folder  | `C:\Users\<User>\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup` |
| LNK parsing context        | `.lnk` files    | Startup folder + other locations                                                |

### Example KAPE Targets

Depending on the version of KAPETargets in your environment, the target names vary. Common targets include:

* `NTUSER` / `UserHives`
* `StartupFolders`
* `LNKFiles`

Example collection:

```
kape.exe --tsource C: --tdest E:\KAPE --target NTUSER,StartupFolders
```

If you want to collect and immediately parse `.lnk` files:

```
kape.exe --tsource C: --tdest E:\KAPE --target NTUSER,StartupFolders --module LECmd
```

### Parsing Modules

| Artifact        | Parser | Typical Module |
| --------------- | ------ | -------------- |
| NTUSER autoruns | RECmd  | `RECmd.mkape`  |
| Startup `.lnk`  | LECmd  | `LECmd.mkape`  |

Example:

```
kape.exe --tsource C: --tdest E:\KAPE --target NTUSER,StartupFolders --module RECmd,LECmd
```

---

## MITRE ATT&CK Mapping (Persistence)

These AutoStart locations map directly to MITRE ATT&CK persistence mechanisms.

### Persistence

* **T1547.001 – Registry Run Keys / Startup Folder**

  * Covers:

    * `HKCU\...\Run`
    * `HKCU\...\RunOnce`
    * `HKLM\...\Run`
    * `HKLM\...\RunOnce`
    * Startup folder

* **T1547.004 – Winlogon Helper DLL / Winlogon Userinit**

  * Covers:

    * `Winlogon\Userinit`

### Defense Evasion (Related)

* **T1036 – Masquerading**

  * Value names designed to look legitimate

* **T1070 – Indicator Removal on Host**

  * Deleting Run/RunOnce values
  * Removing startup folder payloads

---

## RECmd Batch Template (.reb) — Autoruns in One Pass

Below is a cohesive RECmd batch file you can save as:

* `Autoruns_AutoStart_Persistence.reb`

It extracts **all autorun-related keys** referenced in this document.

```yaml
Description: AutoStart Persistence (Registry Run Keys)
Author: DFIR Team
Version: 1
Id: 8b0c0e7e-3c8e-4d62-a1cf-000000000010
Keys:
  # -----------------------------
  # NTUSER.DAT (HKCU)
  # -----------------------------

  - Description: HKCU Run
    HiveType: NTUSER
    Category: Persistence
    KeyPath: Software\Microsoft\Windows\CurrentVersion\Run
    Recursive: false

  - Description: HKCU RunOnce
    HiveType: NTUSER
    Category: Persistence
    KeyPath: Software\Microsoft\Windows\CurrentVersion\RunOnce
    Recursive: false

  # -----------------------------
  # SOFTWARE (HKLM)
  # -----------------------------

  - Description: HKLM Run
    HiveType: SOFTWARE
    Category: Persistence
    KeyPath: Microsoft\Windows\CurrentVersion\Run
    Recursive: false

  - Description: HKLM RunOnce
    HiveType: SOFTWARE
    Category: Persistence
    KeyPath: Microsoft\Windows\CurrentVersion\RunOnce
    Recursive: false

  - Description: HKLM Policies Explorer Run
    HiveType: SOFTWARE
    Category: Persistence
    KeyPath: Microsoft\Windows\CurrentVersion\policies\Explorer\Run
    Recursive: false

  - Description: Winlogon (Userinit)
    HiveType: SOFTWARE
    Category: Persistence
    KeyPath: Microsoft\Windows NT\CurrentVersion\Winlogon
    Recursive: false
```

### RECmd Usage Examples

Parse individual hives:

```
RECmd.exe -f NTUSER.DAT --bn Autoruns_AutoStart_Persistence.reb --csv E:\out
RECmd.exe -f SOFTWARE --bn Autoruns_AutoStart_Persistence.reb --csv E:\out
```

Parse a directory (typical after KAPE acquisition):

```
RECmd.exe -d E:\KAPE\Files --bn Autoruns_AutoStart_Persistence.reb --csv E:\out
```

---

## RECmd Pivot Batch (.reb) — High Recall Autoruns

When you have an indicator (filename, directory, LOLbin) but you’re not sure which persistence key it lives under, use a **high-recall pivot batch**, then keyword search the output.

Save the following as:

* `Autoruns_Pivot.reb`

```yaml
Description: Autoruns Pivot (High Recall)
Author: DFIR Team
Version: 1
Id: 8b0c0e7e-3c8e-4d62-a1cf-000000000011
Keys:
  # -----------------------------
  # NTUSER.DAT (HKCU)
  # -----------------------------

  - Description: HKCU CurrentVersion (broad)
    HiveType: NTUSER
    Category: Persistence
    KeyPath: Software\Microsoft\Windows\CurrentVersion
    Recursive: true

  # -----------------------------
  # SOFTWARE (HKLM)
  # -----------------------------

  - Description: HKLM CurrentVersion (broad)
    HiveType: SOFTWARE
    Category: Persistence
    KeyPath: Microsoft\Windows\CurrentVersion
    Recursive: true

  - Description: HKLM Winlogon (broad)
    HiveType: SOFTWARE
    Category: Persistence
    KeyPath: Microsoft\Windows NT\CurrentVersion\Winlogon
    Recursive: true
```

### Run the Pivot Batch

```
RECmd.exe -f NTUSER.DAT --bn Autoruns_Pivot.reb --csv E:\pivot_out
RECmd.exe -f SOFTWARE --bn Autoruns_Pivot.reb --csv E:\pivot_out
```

### Keyword Search Examples

#### Windows `findstr`

```
findstr /S /I "powershell.exe rundll32.exe mshta.exe C:\Users\Public" E:\pivot_out\*.csv
```

#### PowerShell `Select-String`

```
Get-ChildItem E:\pivot_out\*.csv | Select-String -Pattern "powershell.exe","rundll32.exe","mshta.exe","C:\Users\Public" -CaseSensitive:$false
```

### Notes

* This pivot batch is intentionally broad and may generate large output.
* Use it for **hunting** and **triage**, then confirm findings with the precise batch (`Autoruns_AutoStart_Persistence.reb`) and additional execution artifacts.

---

## Recommended Indicator List (Autoruns Hunting)

Use the following indicator list to quickly pivot through autorun output (CSV/JSON). These are common attacker tradecraft patterns.

### High-Signal LOLBins / Living-off-the-Land

Search for these executables in autorun values:

* `powershell.exe`
* `pwsh.exe`
* `cmd.exe`
* `wscript.exe` / `cscript.exe`
* `mshta.exe`
* `rundll32.exe`
* `regsvr32.exe`
* `schtasks.exe`
* `wmic.exe`
* `bitsadmin.exe`
* `certutil.exe`
* `installutil.exe`

### Suspicious Command Line Patterns

* `-enc` / `-encodedcommand`
* `IEX` / `Invoke-Expression`
* `FromBase64String`
* `DownloadString`
* `WebClient`
* `Start-Process`
* `Hidden` / `WindowStyle Hidden`

### Common Staging / User-Writable Paths

* `C:\Users\Public`
* `%AppData%` / `\AppData\Roaming`
* `%LocalAppData%` / `\AppData\Local`
* `%Temp%` / `\AppData\Local\Temp`
* `C:\ProgramData`
* `C:\Windows\Temp`

### Common Masquerading Filenames

* `svchost.exe`
* `lsass.exe`
* `explorer.exe`
* `taskhostw.exe`
* `services.exe`
* `spoolsv.exe`

> These names are suspicious when found outside `C:\Windows\System32`.

### Quick Pivot Strings

Use these directly in `findstr` / `Select-String`:

* `powershell.exe -enc`
* `rundll32.exe`
* `mshta.exe`
* `wscript.exe`
* `c:\users\public`
* `\appdata\roaming`
* `\appdata\local\temp`
* `c:\programdata`

---

## Tooling Summary

Recommended tools for AutoStart persistence analysis:

* **Sysinternals Autoruns** (excellent triage)
* **Eric Zimmerman Registry Explorer** (manual review)
* **RECmd.exe** (batch parsing of hives)
* **KAPE** (collection + processing)
* **LECmd.exe** (Startup folder `.lnk` parsing)

---

## References

* Sysinternals Autoruns
* Eric Zimmerman Tools
* MITRE ATT&CK Persistence Techniques
